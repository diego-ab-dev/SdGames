<!DOCTYPE html>
<html lang="es">
{% load static %}
{% load custom_filters %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
    <link rel="icon" type="image/png" href="{% static 'images/sdgameslogo.png' %}">
    <link rel="stylesheet" href="{% static 'styles/styles_pago.css' %}">
    <!--IMPORTANTE ES EL KIT DE DESARROLLO DE MERCADO PAGO-->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <title>Metodos de Pago</title>
</head>
<body>
    <div class="container mt-4">
        <h4>Total a pagar: ${{ total|formato_chileno }}</h4>
        <form class="mt-4">
            <div class="mb-3">
                <label class="fw-bold">Método de Pago</label>
                <div>
                    <input type="radio" id="transferencia" name="metodo_pago" value="transferencia" onchange="mostrarFormulario(this.value)" checked>
                    <label for="transferencia">Transferencia Bancaria</label>
                </div>
                <div>
                    <input type="radio" id="mercado_pago" name="metodo_pago" value="mercado_pago" onchange="mostrarFormulario(this.value)">
                    <label for="mercado_pago">Mercado Pago</label>
                </div>
                <div>
                    <input type="radio" id="tarjeta" name="metodo_pago" value="tarjeta" onchange="mostrarFormulario(this.value)">
                    <label for="tarjeta">Tarjeta de Crédito/Débito</label>
                </div>
            </div>
    
            <!-- Formulario de Transferencia -->
            <div id="form_transferencia" class="metodo-pago">
                <p><strong>Datos de la empresa para transferencia:</strong></p>
                <p>Banco: Banco de Chile</p>
                <p>Cuenta Corriente: 12345678</p>
                <p>RUT: 76.123.456-7</p>
                <p>Email: empresa@correo.cl</p>
                <p>Por favor, transfiera el monto exacto y envíe el comprobante al correo mencionado.</p>
            </div>
    
            <!-- Formulario de Mercado Pago -->
            <div id="form_mercado_pago" class="metodo-pago d-none">
                <button id="mercado_pago_button" class="btn btn-primary" data-total="{{ total }}">Pagar con Mercado Pago</button>
            </div>
    
            <!-- Formulario de Tarjeta -->
            <div id="form_tarjeta" class="metodo-pago d-none">
                <div class="mb-3">
                    <label class="fw-bold">Detalles de la Tarjeta</label>
                    <div class="d-flex card-atm border rounded">
                        <input type="text" class="form-control" placeholder="Número de Tarjeta">
                        <input type="text" class="form-control w-25" placeholder="MM/YY">
                        <input type="password" class="form-control w-25" maxlength="3" placeholder="CVV">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Nombre del Titular</label>
                    <input type="text" class="form-control" placeholder="Nombre completo">
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Dirección de Facturación</label>
                    <select class="form-select mb-2">
                        <option selected hidden>Seleccione un país</option>
                        <option>Chile</option>
                        <option>Argentina</option>
                        <option>Perú</option>
                    </select>
                    <input type="text" class="form-control" placeholder="Código Postal">
                </div>
            </div>
    
            <button type="submit" class="btn btn-success w-100 mt-3">Confirmar Pago</button>
        </form>
    </div>


    <script>
            document.getElementById("mercado_pago_button").addEventListener("click", function (event) {
            event.preventDefault();
            console.log("Botón de Mercado Pago clickeado");

            const total = parseFloat(this.getAttribute("data-total"));
            console.log("Total a pagar:", total);

            fetch("/pago/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    metodo_pago: "mercado_pago",
                    total: total
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Respuesta del servidor:", data);

                if (data.redirect_url) {
                    console.log("Redirigiendo a:", data.redirect_url);
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.mensaje || "Error al procesar el pago.");
                }
            })
            .catch(error => console.error("Error en el fetch:", error));
        });



        function mostrarFormulario(metodo) {
            // Oculta todos los formularios
            document.querySelectorAll('.metodo-pago').forEach(function (form) {
                form.classList.add('d-none');
            });
    
            // Muestra el formulario correspondiente
            document.getElementById('form_' + metodo).classList.remove('d-none');
        }
    </script>
    
    
    
</body>
</html>