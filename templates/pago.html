<!DOCTYPE html>
<html lang="es">
{% load static %}
{% load custom_filters %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
    <link rel="icon" type="image/png" href="{% static 'images/sdgameslogo.png' %}">
    <link rel="stylesheet" href="{% static 'styles/styles_pago.css' %}">
    <!--IMPORTANTE ES EL KIT DE DESARROLLO DE MERCADO PAGO-->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <title>Metodos de Pago</title>
</head>
<body>
    <!-- Quita el <form> de aquí -->
<div class="container mt-4">
    <div class="card shadow p-4">
        <h4 class="text-center fw-bold mb-4">Total a pagar: ${{ total|formato_chileno }}</h4>

        <div class="mb-3">
            <label class="fw-bold">Método de Pago</label>
            <div class="form-check">
                <input type="radio" id="transferencia" name="metodo_pago" value="transferencia" onchange="mostrarFormulario(this.value)" checked>
                <label for="transferencia">Transferencia Bancaria</label>
            </div>
            <div class="form-check">
                <input type="radio" id="mercado_pago" name="metodo_pago" value="mercado_pago" onchange="mostrarFormulario(this.value)">
                <label for="mercado_pago">Mercado Pago</label>
            </div>
            <div class="form-check">
                <input type="radio" id="tarjeta" name="metodo_pago" value="tarjeta" onchange="mostrarFormulario(this.value)">
                <label for="tarjeta">Tarjeta de Crédito/Débito</label>
            </div>
        </div>

        <!-- Formulario de Transferencia -->
        <div id="form_transferencia" class="metodo-pago">
            <p><strong>Datos de SD Games para transferencia:</strong></p>
            <p>Banco: Banco de Chile</p>
            <p>Cuenta Corriente: 53674362</p>
            <p>RUT: 76.123.456-7</p>
            <p>Email: sdgames@correo.cl</p>
            <p>Por favor, transfiera el monto exacto y envíe el comprobante al correo mencionado. </p>
            <p class="text-body-secondary">(La confirmacion de la transferencia tarda de 24 hrs a 48 hrs dependiendo la cantidad de ventas)</p>
            <button type="submit" class="btn btn-success w-100 mt-3">Confirmar Pago</button>
        </div>

        <!-- Formulario de Mercado Pago -->
        <div id="form_mercado_pago" class="metodo-pago d-none">
            <button id="mercado_pago_button" class="btn btn-primary w-100" data-total="{{ total }}">Pagar con Mercado Pago</button>
        </div>

        <!-- Formulario de Tarjeta -->
    <div id="tarjeta_form_container" data-total="{{ total|default:0 }}">
        <div id="form_tarjeta" class="metodo-pago d-none">
            <form id="tarjeta_form">
                <div class="mb-3">
                    <label class="fw-bold">Número de Tarjeta</label>
                    <input type="text" id="numero_tarjeta" class="form-control" placeholder="Número de Tarjeta" maxlength="19">
                    <small id="tipo_tarjeta" class="text-muted">Tipo: Desconocida</small>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Fecha de Vencimiento</label>
                    <input type="text" id="fecha_vencimiento" class="form-control" placeholder="MM/YY">
                </div>
                <div class="mb-3">
                    <label class="fw-bold">CVV</label>
                    <input type="password" id="cvv" class="form-control" maxlength="4" placeholder="CVV">
                </div>
                <button type="submit" class="btn btn-success w-100 mt-3">Confirmar Pago</button>
            </form>
        </div>
    </div>
    </div>
</div>

    <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("mercado_pago_button").addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("Botón de Mercado Pago clickeado");

                    const total = parseFloat(this.getAttribute("data-total"));
                    console.log("Total a pagar:", total);

                    fetch("/pago/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            metodo_pago: "mercado_pago",
                            total: total
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error en la solicitud: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            alert(data.mensaje || "Error al procesar el pago.");
                        }
                    })
                    .catch(error => console.error("Error en el fetch:", error));
                });
            });


        function mostrarFormulario(metodo) {
            document.querySelectorAll('.metodo-pago').forEach(function (form) {
                form.classList.add('d-none'); 
            });
            document.getElementById('form_' + metodo).classList.remove('d-none'); 
        }


        function detectarTipoTarjeta(numero) {
        const visaRegex = /^4[0-9]{12}(?:[0-9]{3})?$/; 
        const masterCardRegex = /^5[1-5][0-9]{14}$/;   
        const amexRegex = /^3[47][0-9]{13}$/;          

        if (visaRegex.test(numero)) return "Visa";
        if (masterCardRegex.test(numero)) return "MasterCard";
        if (amexRegex.test(numero)) return "Amex";
        return "Desconocida";
    }

    function validarNumeroTarjeta(numero) {
        let suma = 0, alternar = false;
        for (let i = numero.length - 1; i >= 0; i--) {
            let digito = parseInt(numero.charAt(i), 10);
            if (alternar) {
                digito *= 2;
                if (digito > 9) digito -= 9;
            }
            suma += digito;
            alternar = !alternar;
        }
        return suma % 10 === 0;
    }

    document.querySelector("#numero_tarjeta").addEventListener("input", function () {
        const numero = this.value.replace(/\s+/g, ""); 
        const tipo = detectarTipoTarjeta(numero);
        document.querySelector("#tipo_tarjeta").textContent = tipo;

        if (numero.length >= 13 && validarNumeroTarjeta(numero)) {
            this.classList.add("is-valid");
            this.classList.remove("is-invalid");
        } else {
            this.classList.add("is-invalid");
            this.classList.remove("is-valid");
        }
    });

    const tarjetaForm = document.getElementById('tarjeta_form');
    const total = document.getElementById('tarjeta_form_container').getAttribute('data-total');

    tarjetaForm.addEventListener('submit', function (event) {
        event.preventDefault();

        const numeroTarjeta = document.getElementById('numero_tarjeta').value;
        const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
        const cvv = document.getElementById('cvv').value;
        const tipoTarjeta = document.querySelector('#tipo_tarjeta').textContent;

        fetch('/pago/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                metodo_pago: 'tarjeta',
                numero_tarjeta: numeroTarjeta,
                fecha_vencimiento: fechaVencimiento,
                cvv: cvv,
                tipo_tarjeta: tipoTarjeta,
                total: parseFloat(total),
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Error en el pago.');
            return response.json();
        })
        .then(data => {
            if (data.redirect_url) {
                window.location.href = data.redirect_url; 
            } else {
                alert(data.mensaje || 'Error al procesar el pago.');
            }
        })
        .catch(error => console.error('Error en el fetch:', error));
    });
    </script>
    
    
    
</body>
</html>